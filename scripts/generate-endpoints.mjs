import fs from "fs/promises";
import path from "path";
import { fileURLToPath } from "url";

const __dirname = path.dirname(fileURLToPath(import.meta.url));
const endpointsDir = path.resolve(__dirname, "..", "endpoints");
const outputFile = path.resolve(__dirname, "..", "src", "endpoints.generated.ts");

async function generate() {
  const files = await fs.readdir(endpointsDir);
  const endpoints = {};

  for (const file of files) {
    if (!file.endsWith(".json") || file.startsWith("_")) continue;
    // Reject path traversal: only allow basenames from readdir (no path separators)
    if (file.includes(path.sep) || file === "." || file === "..") continue;
    const filePath = path.join(endpointsDir, file);
    // eslint-disable-next-line security/detect-non-literal-fs-filename -- path from readdir, basename validated above
    const content = await fs.readFile(filePath, "utf-8");
    const json = JSON.parse(content);
    const expectedName = file.replace(/\.json$/, "");
    if (json.name !== expectedName) {
      throw new Error(
        `${file}: "name" must match filename, expected "${expectedName}", got "${json.name}"`
      );
    }
    if (!Array.isArray(json.modes) || !json.modes.includes("normal")) {
      throw new Error(`${file}: "modes" must be an array and include "normal"`);
    }
    endpoints[json.name] = json;
  }

  const output = `// This file is autogenerated by scripts/generate-endpoints.mjs
/* eslint-disable */
export const ENDPOINTS = ${JSON.stringify(endpoints, null, 2)} as const;
`;

  await fs.writeFile(outputFile, output, "utf-8");
  console.log(`Generated ${outputFile} with ${Object.keys(endpoints).length} endpoints.`);
}

generate().catch((err) => {
  console.error(err);
  process.exit(1);
});
